# 扩展查询标签

## 概述

默认情况下，Medical Imaging Server for DICOM 支持查询[符合性声明](https://github.com/microsoft/dicom-server/blob/main/docs/resources/conformance-statement.md#searchable-attributes)中指定的 DICOM 标签。但是，可以通过启用*扩展查询标签*来扩展此标签列表。使用下面列出的 API，用户可以额外索引其 DICOM 研究、序列和实例的标准和私有 DICOM 标签，以便可以在 QIDO-RS 中指定它们。

## API

### 版本：v1-prerelease, v1

为了帮助管理给定 DICOM 服务器实例中支持的标签，已添加以下 API 端点。

| API                                               | 描述                                                  |
| ------------------------------------------------- | ------------------------------------------------------------ |
| POST       .../extendedquerytags                  | [添加扩展查询标签](#添加扩展查询标签)          |
| GET         .../extendedquerytags                 | [列出扩展查询标签](#列出扩展查询标签)        |
| GET         .../extendedquerytags/{tagPath}       | [获取扩展查询标签](#获取扩展查询标签)            |
| DELETE  .../extendedquerytags/{tagPath}           | [删除扩展查询标签](#删除扩展查询标签)      |
| PATCH   .../extendedquerytags/{tagPath}           | [更新扩展查询标签](#更新扩展查询标签)      |
| GET        .../extendedquerytags/{tagPath}/errors | [列出扩展查询标签错误](#列出扩展查询标签错误) |
| GET        .../operations/{operationId}           | [获取操作](#获取操作)                              |

### 添加扩展查询标签

添加一个或多个扩展查询标签，并启动长时间运行的操作，以在指定标签上重新索引当前 DICOM 实例。

```http
POST .../extendedquerytags
```

#### 请求头

| 名称         | 必需 | 类型   | 描述                     |
| ------------ | -------- | ------ | ------------------------------- |
| Content-Type | True     | string | 支持 `application/json` |

#### 请求体

| 名称 | 必需 | 类型                                                         | 描述 |
| ---- | -------- | ------------------------------------------------------------ | ----------- |
| body |          | [用于添加的扩展查询标签](#用于添加的扩展查询标签)`[]` |             |

#### 限制

支持以下 VR 类型：

| VR   | 描述           | 单值匹配 | 范围匹配 | 模糊匹配 |
| ---- | --------------------- | --------------------- | -------------- | -------------- |
| AE   | Application Entity    | X                     |                |                |
| AS   | Age String            | X                     |                |                |
| CS   | Code String           | X                     |                |                |
| DA   | Date                  | X                     | X              |                |
| DS   | Decimal String        | X                     |                |                |
| DT   | Date Time             | X                     | X              |                |
| FD   | Floating Point Double | X                     |                |                |
| FL   | Floating Point Single | X                     |                |                |
| IS   | Integer String        | X                     |                |                |
| LO   | Long String           | X                     |                |                |
| PN   | Person Name           | X                     |                | X              |
| SH   | Short String          | X                     |                |                |
| SL   | Signed Long           | X                     |                |                |
| SS   | Signed Short          | X                     |                |                |
| TM   | Time                  | X                     | X              |                |
| UI   | Unique Identifier     | X                     |                |                |
| UL   | Unsigned Long         | X                     |                |                |
| US   | Unsigned Short        | X                     |                |                |

> 目前不支持序列标签，即序列项类型 (SQ) 标签下的标签。

> 最多可以添加 128 个扩展查询标签。

> 对于错误地具有多个值的单值数据元素，仅索引第一个值。

> 如果值为 null 或空，我们不会索引扩展查询标签。

#### 响应

| 名称              | 类型                                        | 描述                                                  |
| ----------------- | ------------------------------------------- | ------------------------------------------------------------ |
| 202 (Accepted)    | [操作引用](#操作引用) | 已添加扩展查询标签，并已启动长时间运行的操作以重新索引现有 DICOM 实例 |
| 400 (Bad Request) |                                             | 请求体包含无效数据                                |
| 409 (Conflict)    |                                             | 一个或多个请求的查询标签已受支持       |

### 列出扩展查询标签

列出所有扩展查询标签。

```http
GET .../extendedquerytags
```

#### 响应

| 名称     | 类型                                          | 描述                 |
| -------- | --------------------------------------------- | --------------------------- |
| 200 (OK) | [扩展查询标签](#扩展查询标签)`[]` | 返回扩展查询标签 |

### 获取扩展查询标签

获取扩展查询标签。

```http
GET .../extendedquerytags/{tagPath}
```

#### URI 参数

| 名称    | 位置   | 必需 | 类型   | 描述                                                  |
| ------- | ---- | -------- | ------ | ------------------------------------------------------------ |
| tagPath | path | True     | string | tagPath 是标签的路径，可以是标签或关键字。例如，Patient Id 由 `00100020` 或 `PatientId` 表示 |

####  响应

| 名称              | 类型                                      | 描述                                            |
| ----------------- | ----------------------------------------- | ------------------------------------------------------ |
| 200 (OK)          | [扩展查询标签](#扩展查询标签) | 具有指定 `tagPath` 的扩展查询标签    |
| 400 (Bad Request) |                                           | 请求的标签路径无效                          |
| 404 (Not Found)   |                                           | 未找到具有请求 tagPath 的扩展查询标签 |

### 删除扩展查询标签

删除扩展查询标签。

```http
DELETE .../extendedquerytags/{tagPath}
```

#### URI 参数

| 名称    | 位置   | 必需 | 类型   | 描述                                                  |
| ------- | ---- | -------- | ------ | ------------------------------------------------------------ |
| tagPath | path | True     | string | tagPath 是标签的路径，可以是标签或关键字。例如，Patient Id 由 `00100020` 或 `PatientId` 表示 |

#### 响应

| 名称              | 类型 | 描述                                                  |
| ----------------- | ---- | ------------------------------------------------------------ |
| 204 (No Content)  |      | 已成功删除具有请求 tagPath 的扩展查询标签。 |
| 400 (Bad Request) |      | 请求的标签路径无效。                               |
| 404 (Not Found)   |      | 未找到具有请求 tagPath 的扩展查询标签       |

### 更新扩展查询标签

更新扩展查询标签。

```http
PATCH .../extendedquerytags/{tagPath}
```

#### URI 参数

| 名称    | 位置   | 必需 | 类型   | 描述                                                  |
| ------- | ---- | -------- | ------ | ------------------------------------------------------------ |
| tagPath | path | True     | string | tagPath 是标签的路径，可以是标签或关键字。例如，Patient Id 由 `00100020` 或 `PatientId` 表示 |

#### 请求头

| 名称         | 必需 | 类型   | 描述                      |
| ------------ | -------- | ------ | -------------------------------- |
| Content-Type | True     | string | 支持 `application/json`。 |

#### 请求体

| 名称 | 必需 | 类型                                                         | 描述 |
| ---- | -------- | ------------------------------------------------------------ | ----------- |
| body |          | [用于更新的扩展查询标签](#用于更新的扩展查询标签) |             |

#### 响应

| 名称              | 类型                                      | 描述                                            |
| ----------------- | ----------------------------------------- | ------------------------------------------------------ |
| 200 (OK)           | [扩展查询标签](#扩展查询标签) | 更新的扩展查询标签                         |
| 400 (Bad Request) |                                           | 请求的标签路径或正文无效                  |
| 404 (Not Found)   |                                           | 未找到具有请求 tagPath 的扩展查询标签 |

### 列出扩展查询标签错误

列出扩展查询标签的错误。

```http
GET .../extendedquerytags/{tagPath}/errors
```

#### URI 参数

| 名称    | 位置   | 必需 | 类型   | 描述                                                  |
| ------- | ---- | -------- | ------ | ------------------------------------------------------------ |
| tagPath | path | True     | string | tagPath 是标签的路径，可以是标签或关键字。例如，Patient Id 由 `00100020` 或 `PatientId` 表示 |

####  响应

| 名称              | 类型                                                       | 描述                                               |
| ----------------- | ---------------------------------------------------------- | --------------------------------------------------------- |
| 200 (OK)          | [扩展查询标签错误](#扩展查询标签错误) `[]` | 与标签关联的扩展查询标签错误列表 |
| 400 (Bad Request) |                                                            | 请求的标签路径无效                             |
| 404 (Not Found)   |                                                            | 未找到具有请求 tagPath 的扩展查询标签    |

### 获取操作

获取长时间运行的操作。

```http
GET .../operations/{operationId}
```

#### URI 参数

| 名称        | 位置   | 必需 | 类型   | 描述      |
| ----------- | ---- | -------- | ------ | ---------------- |
| operationId | path | True     | string | 操作 ID |

#### 响应

| 名称            | 类型                    | 描述                                  |
| --------------- | ----------------------- | -------------------------------------------- |
| 200 (OK)        | [操作](#操作) | 指定 ID 的已完成操作 |
| 202 (Accepted)  | [操作](#操作) | 指定 ID 的运行中操作   |
| 404 (Not Found) |                         | 未找到操作                   |

## 使用扩展查询标签的 QIDO

### 标签状态

扩展查询标签的[状态](#扩展查询标签状态)指示当前状态。首次添加扩展查询标签时，其状态设置为 `Adding`，并启动长时间运行的操作以重新索引现有 DICOM 实例。操作完成后，标签状态更新为 `Ready`。扩展查询标签现在可以在 [QIDO](../resources/conformance-statement.md#search-qido-rs) 中使用。

例如，如果添加标签 Manufacturer Model Name (0008,1090) 并处于 `Ready` 状态，此后可以使用以下查询按 Manufacturer Model Name 过滤存储的实例：

```http
../instances?ManufacturerModelName=Microsoft
```

它们也可以与现有标签结合使用。例如：

```http
../instances?00081090=Microsoft&PatientName=Jo&fuzzyMatching=true
```

> 添加扩展查询标签后，存储的任何 DICOM 实例都会在其上建立索引

### 标签查询状态

[QueryStatus](#扩展查询标签状态) 指示是否允许对该标签进行 QIDO。当重新索引操作无法处理标签的一个或多个 DICOM 实例时，该标签的 QueryStatus 会自动设置为 `Disabled`。您可以选择忽略索引错误，并通过 [更新扩展查询标签](#更新扩展查询标签) API 将 `QueryStatus` 设置为 `Enabled` 来允许查询使用此标签。任何引用至少一个手动启用的标签的 QIDO 请求都将在响应头 `erroneous-dicom-attributes` 中包含具有索引错误的标签集。

例如，假设扩展查询标签 `PatientAge` 在重新索引期间出现错误，但已手动启用。对于下面的查询，您将能够在 `erroneous-dicom-attributes` 标头中看到 `PatientAge`。

```http
../instances?PatientAge=035Y
```

## 定义

### 扩展查询标签

将支持 QIDO-RS 的非标准 DICOM 标签。

| 名称           | 类型                                                         | 描述                                                  |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Path           | string                                                       | 标签路径，通常由组 ID 和元素 ID 组成。例如，`PatientId` (0010,0020) 的路径为 00100020 |
| VR             | string                                                       | 此标签的值表示                             |
| PrivateCreator | string                                                       | 此私有标签的实现者的标识代码   |
| Level          | [扩展查询标签级别](#扩展查询标签级别)        | 扩展查询标签的级别                                  |
| Status         | [扩展查询标签状态](#扩展查询标签状态)      | 扩展查询标签的状态                             |
| QueryStatus    | [扩展查询标签查询状态](#扩展查询标签查询状态) | 扩展查询标签的查询状态                           |
| Errors         | [扩展查询标签错误引用](#扩展查询标签错误引用) | 对扩展查询标签错误的引用                       |
| Operation      | [操作引用](#操作引用)                  | 对长时间运行操作的引用                        |

**示例1：** 处于 `Ready` 状态的标准标签 (0008,0070)。

```json
{
    "status": "Ready",
    "level": "Instance",
    "queryStatus": "Enabled",
    "path": "00080070",
    "vr": "LO"
}
```

**示例2：** 处于 `Adding` 状态的标准标签 (0010,1010)。一个 ID 为 `1a5d0306d9624f699929ee1a59ed57a0` 的操作正在其上运行，到目前为止已发生 21 个错误。

```json
{
    "status": "Adding",
    "level": "Study",
    "errors": {
        "count": 21,
        "href": "https://localhost:63838/extendedquerytags/00101010/errors"
    },
    "operation": {
        "id": "1a5d0306d9624f699929ee1a59ed57a0",
        "href": "https://localhost:63838/operations/1a5d0306d9624f699929ee1a59ed57a0"
    },
    "queryStatus": "Disabled",
    "path": "00101010",
    "vr": "AS"
}
```

### 操作引用

对长时间运行操作的引用。

| 名称 | 类型   | 描述          |
| ---- | ------ | -------------------- |
| Id   | string | 操作 ID         |
| Href | string | 操作的 Uri |

### 操作

表示长时间运行的操作。

| 名称            | 类型                                  | 描述                                                  |
| --------------- | ------------------------------------- | ------------------------------------------------------------ |
| OperationId     | string                                | 操作 ID                                             |
| OperationType   | [操作类型](#操作类型)     | 长时间运行操作的类型                          |
| CreatedTime     | string                                | 创建操作的时间                          |
| LastUpdatedTime | string                                | 上次更新操作的时间                |
| Status          | [操作状态](#操作状态) | 表示操作的运行时状态                      |
| PercentComplete | Integer                               | 操作已完成的工作百分比  |
| Resources       | string`[]`                            | 操作正在创建或操作的资源位置的集合 |

**示例：** 正在运行的重新索引操作。

```json
{
    "resources": [
        "https://localhost:63838/extendedquerytags/00101010"
    ],
    "operationId": "a99a8b51-78d4-4fd9-b004-b6c0bcaccf1d",
    "type": "Reindex",
    "createdTime": "2021-10-06T16:40:02.5247083Z",
    "lastUpdatedTime": "2021-10-06T16:40:04.5152934Z",
    "status": "Running",
    "percentComplete": 10
}
```

### 操作状态

表示长时间运行操作的运行时状态。

| 名称       | 类型   | 描述                                                  |
| ---------- | ------ | ------------------------------------------------------------ |
| NotStarted | string | 操作未启动                                 |
| Running    | string | 操作正在执行但尚未完成          |
| Completed  | string | 操作已成功完成                      |
| Failed     | string | 操作在遇到一个或多个错误后过早停止 |

### 扩展查询标签错误

在扩展查询标签索引操作期间发生的错误。

| 名称              | 类型   | 描述                                       |
| ----------------- | ------ | ------------------------------------------------- |
| StudyInstanceUid  | string | 发生索引错误的研究实例 UID  |
| SeriesInstanceUid | string | 发生索引错误的序列实例 UID |
| SopInstanceUid    | string | 发生索引错误的 Sop 实例 UID    |
| CreatedTime       | string | 发生错误的时间(UTC)                      |
| ErrorMessage      | string | 错误消息                                     |

**示例**：DICOM 实例上的意外值长度错误。它发生在 2021-10-06T16:41:44.4783136。

```json
{
    "studyInstanceUid": "2.25.253658084841524753870559471415339023884",
    "seriesInstanceUid": "2.25.309809095970466602239093351963447277833",
    "sopInstanceUid": "2.25.225286918605419873651833906117051809629",
    "createdTime": "2021-10-06T16:41:44.4783136",
    "errorMessage": "Value length is not expected."
}
```

### 扩展查询标签错误引用

对扩展查询标签错误的引用。

| 名称  | 类型    | 描述                                      |
| ----- | ------- | ------------------------------------------------ |
| Count | Integer | 扩展查询标签上的错误总数 |
| Href  | string  | 扩展查询标签错误的 Uri                 |

### 操作类型

长时间运行操作的类型。

| 名称    | 类型   | 描述                                                  |
| ------- | ------ | ------------------------------------------------------------ |
| Reindex | string | 根据新标签更新先前添加数据的索引的重新索引操作 |

### 扩展查询标签状态

扩展查询标签的状态。

| 名称     | 类型   | 描述                                                  |
| -------- | ------ | ------------------------------------------------------------ |
| Adding   | string | 已添加扩展查询标签，并且长时间运行的操作正在重新索引现有 DICOM 实例 |
| Ready    | string | 扩展查询标签已准备好用于 QIDO-RS                 |
| Deleting | string | 正在删除扩展查询标签                     |

### 扩展查询标签级别

此标签适用的 DICOM 信息层次结构的级别。

| 名称     | 类型   | 描述                                              |
| -------- | ------ | -------------------------------------------------------- |
| Instance | string | 扩展查询标签在实例级别相关 |
| Series   | string | 扩展查询标签在序列级别相关   |
| Study    | string | 扩展查询标签在研究级别相关    |

### 扩展查询标签查询状态

扩展查询标签的查询状态。

| 名称     | 类型   | 描述                                         |
| -------- | ------ | --------------------------------------------------- |
| Disabled | string | 不允许查询扩展查询标签 |
| Enabled  | string | 允许查询扩展查询标签     |

> 注意：重新索引操作期间的错误会禁用扩展查询标签上的 QIDO。您可以调用 [更新扩展查询标签](#更新扩展查询标签) API 来启用它。

### 用于更新的扩展查询标签

表示用于更新的扩展查询标签。

| 名称        | 类型                                                         | 描述                            |
| ----------- | ------------------------------------------------------------ | -------------------------------------- |
| QueryStatus | [扩展查询标签查询状态](#扩展查询标签查询状态) | 扩展查询标签的查询状态 |

### 用于添加的扩展查询标签

表示用于添加的扩展查询标签。

| 名称           | 必需 | 类型                                                  | 描述                                                  |
| -------------- | -------- | ----------------------------------------------------- | ------------------------------------------------------------ |
| Path           | True     | string                                                | 标签路径，通常由组 ID 和元素 ID 组成。例如，`PatientId` (0010,0020) 的路径为 00100020 |
| VR             |          | string                                                | 此标签的值表示。对于标准标签是可选的，对于私有标签是必需的 |
| PrivateCreator |          | string                                                | 此私有标签的实现者的标识代码。仅在标签是私有标签时设置 |
| Level          | True     | [扩展查询标签级别](#扩展查询标签级别) | 表示此标签相关的层次结构。应该是 Study、Series 或 Instance 之一 |

**示例1：** `MicrosoftPC` 在实例级别定义具有 `SS` 值表示的私有标签 (0401,1001)

```json
{
    "Path": "04011001",
    "VR": "SS",
    "PrivateCreator": "MicrosoftPC",
    "Level": "Instance"
}
```

**示例2：** 在序列级别定义具有 `LO` 值表示的关键字为 `ManufacturerModelName` 的标准标签

```json
{
    "Path": "ManufacturerModelName",
    "VR": "LO",
    "Level": "Series"
}
```

 **示例3：** 在研究级别定义标准标签 (0010,0040)：值表示已由 DICOM 标准定义

```json
{
    "Path": "00100040",
    "Level": "Study"
}
```
